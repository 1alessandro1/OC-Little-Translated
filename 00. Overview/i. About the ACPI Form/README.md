# ACPI Form and Patches

## ACPI – A Brief description 

ACPI (Advanced Configuration & Power Interface) is an advanced computer configuration and power interface, which is a power management standard developed by Intel, Microsoft and other manufacturers, namely [`ACPI specification`](https://www.acpica.org/documentation). Each computer is shipped with a set of binary files that conform to the ACPI specification, which we call ACPI forms. The number and content of ACPI forms varies from machine to machine and **may** vary between differen BIOS versions as well. 

**ACPI Forms include:**

* `DSDT.aml`
* Multiple SSDT-xxxx.aml, such as: `SSDT-SataAhci.aml`, `SSDT-CpuSsdt.aml`, `SSDT-CB-01.aml`, etc.
* Other .aml such as: `APIC.aml`, `BGRT.aml`, `DMAR.aml`, `ECDT.aml`, etc.

The ACPI Form describes the machine's hardware information in `.aml` format and does not have any driver capabilities of its own. However, the correct ACPI is required for a piece of hardware to work properly, and the wrong way of describing it can lead to boot failures or system crashes. For example, if the machine has a Broadcom NIC plugged in, but in the ACPI it's described as an Intel NIC, the system will load the Intel NIC driver, which is obviously wrong. Another example is that the machine does not provide `auto-adjust brightness` hardware, even if the ACPI adds `SSDT-ALS0`, the brightness can not be adjusted automatically.

Some Tools and Bootloaders can extract the machine's ACPI Form, like Aida64 under Windows, Bootloaders like OpenCore and Clover, etc. in macOS. Because ACPI forms are binary files, we need a decompiler to help us to read their contents, such as [MaciASL](https://github.com/acidanthera/MaciASL) for macOS or [QtiASL](https://github.com/ic005k/QtiASL) for Windows. When opening these forms, especially when opening `DSDT.aml`, many errors may occur. It is important to note that in most cases, these errors are generated by the decompiler – they are not present in the ACPI forms provided by the machine.

Because the working principles of Windows and macOS are different, Hackintoshes require fixes for certain ACPI Tables. Havin a correct ACPI is the foundation of stable working Hackintosh. **Hotpatching** is highly recommended to patch the ACPI. Hotpatches can be a good way to avoid the so-called `DSDT` errors.

For more details about ACPI, please refer to the official [`ACPI Specifications`](https://www.acpica.org/documentation); for an introduction to the aml language, please refer to chapter "ASL Syntax Basics".

### ACPI Patches in OpenCore
The following section refers to patching other ACPI Tables apart from the `DSDT.aml`, which most SSDT Hotpatches in the OC Little Repository are addressing.

OpenCore, applies ACPI changes applied globally to *every* operating system (unlike Clover) in the following order (as defined in the `config.plist`):

1. `Patch` is processed
2. `Delete` is processed 
3. `Add` is processed
4. `Quirks` are processed

#### Other ACPI Tables and Patching Methods

- **Clear ACPI Header fields** 
	- **Patch method**: `ACPI\Quirks\NormalizeHeaders` = `true` 
	- **Note**: Only required on macOS 10.13

- **Relocate ACPI Memory Regions** 
    - **Patch method**: `ACPI\Quirks\RebaseRegions` = `true` 
    - **Description**: ACPI forms have memory regions with both dynamically allocated addresses and fixed addresses. 
    - **Caution**: This patch is very dangerous and should not be chosen unless relocating memory regions solves boot crashes!

- **FACP.aml** 
  - **Patch method**: `ACPI\Quirks\FadtEnableReset` = `true` 
  - **Description**: [`ACPI Specification`](https://www.acpica.org/documentation) defines various system states related to configuration and power management in terms of **FADT** which is represented by an **FACP.aml** in the machine's ACPI Table. The **FACP.aml** implements features such as the RTC Clock, Power and Sleep buttons, Power Management, etc. In Hackintoshland this affects the following fuctions:
		- If you press the **Power Button** and cannot call out the "Restart, Sleep, Cancel, Shutdown" menu, try setting `ACPI\Quirks\FadtEnableReset`to `true`. If this doesn't fix it, try adding ***SSDT-PMCR*** instead. It's located under "Adding Missing Parts".
		- `Low Power S0 Idle` state. Tthe **FACP.aml** form characterizes the machine type and determines the power management method. If `Low Power S0 Idle` = `1`, it's an `AOAC` (Always On Always Connected) type of computer. See the "About AOAC" section for more details on `AOAC`.

- **FACS.aml** 
    - **Patch method**: `ACPI\Quirks\ResetHwSig` = `true` 
    - **Decription**: The `Hardware Signature` item of the **FACS.aml** form is a 4-byte hardware signature, which is calculated after the system boots based on the hardware configuration. If this value is changed after the machine wakes up from a **Hibernate** state, the system will not recover correctly. The patch works by setting the `Hardware Signature` = `0` to resolve this issue.
    - **Note:** If the system has **Hibernation** disabled, you do not need to bother with this patch!

- **BGRT.aml** 
    - **Patch method**: `ACPI\Quirks\ResetLogoStatus` = `true` 
    - **Description**: **BGRT.aml** form is the bootstrap graphics resource table. According to the [`ACPI specification`](https://www.acpica.org/documentation), the `Displayed` item of the form should = `0`. However, some vendors have written non-zero data to the `Displayed` entry for some reason, which may cause the screen refresh to fail during the boot phase. The patch works to make `Displayed` = `0`.
    - **Note:** Not all machines have this form

- **DMAR.aml** 
    - **Patch method**: `Kernel\Quirks\DisableIoMapper` = `true` 
    - **Description**: The patch works the same as disbabling `VT-d` in BIOS or using a `DropDMAR.aml` 
    - **Note**: Only early Mac systems need this patch

- **ECDT.aml**:
    - **Patch Method**: Binary rename to rename it to `EC`. Has to be appliad globally so all references to its Name and `Namepath` in all of the ACPI forms are identical. Otherwise the whole ACPI gets borked.
    - **Description**: Embedded Controller.
    - **Note**: Individual machines (e.g. **Lenovo yoga-s740**) have `Namepath` in the **ECDT.aml** form that is inconsistent with the `EC` name of other ACPI forms, which can cause ACPI errors during the boot process. This patch is a good solution to the ACPI error problem.
    - **Note**: Not all machines have this table. Use SSDTTime to generate a fake EC.
